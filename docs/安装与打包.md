# 安装与打包（ddf_lib/include + ddf_lib/bin）

本文档说明如何将本项目构建产物整理为一个可分发的目录结构：

- `ddf_lib/include/`：从 `src/` 拷贝的全部头文件，保持原目录结构（含 3 个聚合头文件）
- `ddf_lib/bin/`：三个动态库 `libMB_DDF_CORE.so`、`libMB_DDF_PHYSICAL.so`、`libMB_DDF_TOOLS.so`

该流程适用于本机构建与交叉编译产物的归档与交付。

## 目录结构与内容

执行安装后会得到：

```text
ddf_lib/
  include/
    MB_DDF/
      MB_DDF_CORE.h
      MB_DDF_PHYSICAL.h
      MB_DDF_TOOLS.h
      ...（其余头文件，保持 src/ 下的层级）
  bin/
    libMB_DDF_CORE.so
    libMB_DDF_PHYSICAL.so
    libMB_DDF_TOOLS.so
```

3 个聚合头文件用途：

- `MB_DDF/MB_DDF_CORE.h`：汇总 DDS/Debug/Monitor 相关头文件
- `MB_DDF/MB_DDF_PHYSICAL.h`：汇总 PhysicalLayer 相关头文件（并包含 CORE 以满足依赖）
- `MB_DDF/MB_DDF_TOOLS.h`：汇总 Timer/Tools 相关头文件

## 安装命令（推荐）

安装逻辑已写入 CMake 的 install 规则，因此推荐使用 CMake 安装命令来生成 `ddf_lib/`：

### 交叉编译（aarch64）

```bash
./build.sh -r --cross
cmake --install build/aarch64 --prefix ./ddf_lib
```

### 本机构建（host）

```bash
./build.sh -r
cmake --install build/host --prefix ./ddf_lib
```

说明：

- `--prefix ./ddf_lib` 表示将安装前缀设置为项目根目录下的 `ddf_lib/`
- 安装会创建 `ddf_lib/include` 与 `ddf_lib/bin`
- 安装会从 `src/` 中筛选并复制所有 `.h/.hpp` 到 `ddf_lib/include/`
- 安装会把三套动态库安装到 `ddf_lib/bin/`

## 安装逻辑（实现约定）

安装规则做了两件事：

1. 安装三套动态库到 `ddf_lib/bin/`
2. 安装 `src/` 下所有头文件到 `ddf_lib/include/`，并保持原目录结构

对应实现位于项目根目录的 CMake 配置中（`install(TARGETS ...)` 与 `install(DIRECTORY ...)` 规则）。

## 注意事项

### 1) 运行时动态库搜索路径

交叉编译时如果启用了额外的第三方库前缀（例如 `/opt/arm64-libs`），目标板运行时可能需要把第三方库目录加入动态库搜索路径，例如：

```bash
export LD_LIBRARY_PATH=/opt/arm64-libs/lib:$LD_LIBRARY_PATH
```

如果你的目标板上动态链接报错（找不到 `libaio.so` / `liburing.so` / `libgpiod.so` 等），优先检查该路径与实际部署是否匹配。

### 2) 交叉编译工具链与 sysroot

`./build.sh --cross` 会使用交叉编译工具链与 sysroot（由脚本默认值或环境覆盖决定）。如果你的工具链路径不同，需要确保：

- 工具链可用：`aarch64-ucas-linux-gcc/g++` 等
- sysroot 正确：能找到目标架构的系统头文件与运行库

### 3) 可选依赖的启用/禁用

物理层库会尝试启用以下可选能力（找不到时会自动降级）：

- `libaio`：异步 DMA 支持（编译时定义 `MB_DDF_HAS_LIBAIO`）
- `liburing`：io_uring 异步支持（编译时定义 `MB_DDF_HAS_IOURING`）
- `libgpiod`：GPIO event fd 支持（找不到时 SpiTransport 的 GPIO 事件 fd 会禁用）

### 4) 头文件包含方式建议

如果你希望外部项目通过一个头文件引入某个库的全部 API，优先使用聚合头文件：

```cpp
#include "MB_DDF/MB_DDF_CORE.h"
#include "MB_DDF/MB_DDF_PHYSICAL.h"
#include "MB_DDF/MB_DDF_TOOLS.h"
```

如果你希望更细粒度控制编译依赖与编译时间，则按模块包含对应子目录头文件即可。

